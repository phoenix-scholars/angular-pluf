/*! angular-pluf 2016-05-28 */
!function(){angular.module("pluf",[]).run(function($usr,$act){$act.command({id:"pluf.user.login",label:"login",description:"login a user",visible:function(){return $usr.isAnonymous()},category:"usr"}).handler({commandId:"pluf.user.login",handle:function(){if(arguments.length<1)throw new PException("no credentioal");var a=arguments[0];return $usr.login(a.username,a.password)}}).command({id:"pluf.user.logout",label:"logout",description:"logout the user",visible:function(){return!$usr.isAnonymous()},category:"usr"}).handler({commandId:"pluf.user.logout",handle:function(){return $usr.logout()}}).command({id:"pluf.user.update",label:"update",description:"update the current user",visible:function(){return!$usr.isAnonymous()}}).handler({commandId:"pluf.user.update",handle:function(){if(arguments.length<1)throw new PException("bad param");var a=arguments[0];return $usr.session().then(function(user){return user.update(a.key,a.value)})}}).command({id:"pluf.user.profile.update",label:"update profile",description:"update user profile",visible:function(){return!$usr.isAnonymous()}}).handler({commandId:"pluf.user.profile.update",handle:function(){if(arguments.length<1)throw new PException("bad param");var a=arguments[0];return $usr.session().then(function(user){return user.profile()}).then(function(profile){return profile.update(a.key,a.value)})}})})}(),function(angular){function PCommand(){var pCommand=function(data){this.priority=0,this.tags=[],data&&this.setData(data),this.handlers=[],"visible"in data||(this.visible=function(){return!0}),"enable"in data||(this.enable=function(){return!0})};return pCommand.prototype.setData=function(data){return angular.extend(this,data),this},pCommand.prototype.handler=function(h){return this.handlers.push(h),this},pCommand.prototype.tag=function(tag){this.tags.push(tag)},pCommand}angular.module("pluf").factory("PCommand",[PCommand])}(window.angular),function(){function PContent($http,$httpParamSerializerJQLike,$q,PObject,PException){var pContent=function(){PObject.apply(this,arguments)};return pContent.prototype=new PObject,pContent.prototype.update=function(){},pContent.prototype.remove=function(){},pContent.prototype.value=function(){return $http({method:"GET",url:"/api/saascms/content/"+this.id+"/download"}).then(function(res){return res.data})},pContent.prototype.setValue=function(d){var scope=this;return $http({method:"POST",url:"/api/saascms/content/"+this.id+"/download",data:d}).then(function(res){return scope})},pContent}angular.module("pluf").factory("PContent",["$http","$httpParamSerializerJQLike","$q","PObject","PException",PContent])}(),function(){function PException(PObject){var pException=function(){PObject.apply(this,arguments)};return pException.prototype=new PObject,pException}angular.module("pluf").factory("PException",["PObject",PException])}(),function(angular){function PHandler(){var pHandler=function(data){this.priority=0,data&&this.setData(data)};return pHandler.prototype.setData=function(data){return angular.extend(this,data),this},pHandler}angular.module("pluf").factory("PHandler",[PHandler])}(window.angular),function(angular){function PMenu(){var pMenu=function(data){this.priority=0,this.tags=[],data&&this.setData(data),this.items=[]};return pMenu.prototype.setData=function(data){return angular.extend(this,data),this},pMenu.prototype.item=function(h){return this.items.push(h),this},pMenu.prototype.tag=function(tag){this.tags.push(tag)},pMenu}angular.module("pluf").factory("PMenu",["PMenuItem",PMenu])}(window.angular),function(angular){function PMenuItem($window,$act){var pMenuItem=function(data){this.priority=0,this.tags=[],data&&this.setData(data)};return pMenuItem.prototype.setData=function(data){if("command"in data){var scope=this;$act.getCommand(data.command).then(function(command){angular.extend(scope,command),angular.extend(scope,data)})}else angular.extend(this,data);return this},pMenuItem.prototype.tag=function(tag){this.tags.push(tag)},pMenuItem.prototype.active=function(){if("command"in this){var args=[menu.command];return this.params instanceof Array&&(args=args.concat(this.params)),$act.execute.apply($act,args)}if("action"in this)return this.action();if("link"in this)return void($window.location=this.link);throw{status:404,code:523,message:"Menu item is not supported"}},pMenuItem}angular.module("pluf").factory("PMenuItem",["$window","$act",PMenuItem])}(window.angular),function(angular){function PMessage(){var pMessage=function(data){data&&this.setData(data)};return pMessage.prototype.setData=function(data){return angular.extend(this,data),this},pMessage.prototype.isInfo=function(){return"info"==this.type},pMessage.prototype.isDebug=function(){return"debug"==this.type},pMessage.prototype.isWarning=function(){return"warning"==this.type},pMessage.prototype.isError=function(){return"error"==this.error},pMessage}angular.module("pluf").factory("PMessage",[PMessage])}(window.angular),function(){function PNamedContent($http,$httpParamSerializerJQLike,$q,PObject,PException,PContent){var pNamedContent=function(){PObject.apply(this,arguments)};return pNamedContent.prototype=new PObject,pNamedContent.prototype.update=function(){},pNamedContent.prototype.remove=function(){},pNamedContent.prototype.value=function(){return this.content.value()},pNamedContent.prototype.setValue=function(v){return this.content.setValue(v)},pNamedContent}angular.module("pluf").factory("PNamedContent",["$http","$httpParamSerializerJQLike","$q","PObject","PException","PContent",PNamedContent])}(),function(){function PObject(){var pObject=function(data){data&&this.setData(data)};return pObject.prototype={setData:function(data){angular.extend(this,data)},isAnonymous:function(){return!(this.id&&this.id>0)}},pObject}angular.module("pluf").factory("PObject",[PObject])}(),function(){function PaginatorPage(PObject){var paginatorPage=function(){PObject.apply(this,arguments)};return paginatorPage.prototype=new PObject,paginatorPage}angular.module("pluf").factory("PaginatorPage",["PObject",PaginatorPage])}(),function(){function PaginatorParameter(){var pagParam=function(paginatorParam){paginatorParam?this.setData(paginatorParam):this.setData({})};return pagParam.prototype={param:{},setData:function(paginatorParam){this.param=paginatorParam},setSize:function($size){return this.param._px_c=$size,this},setQuery:function($query){return this.param._px_q=$query,this},setPage:function($page){return this.param._px_p=$page,this},setOrder:function($key,$order){return this.param._px_sk=$key,this.param._px_so=$order,this},setFilter:function($key,$value){return this.param._px_fk=$key,this.param._px_fv=$value,this},getParameter:function(){return this.param}},pagParam}angular.module("pluf").factory("PaginatorParameter",[PaginatorParameter])}(),function(){function PPreferenceNode(PObject){var pPreferenceNode=function(){PObject.apply(this,arguments)};return pPreferenceNode.prototype=new PObject,pPreferenceNode.prototype.newNode=function(n){var def=$q.defer(),scope=this;return $timeout(function(){var node=new pPreferenceNode;scope.children[n]=section,def.resolve(node)},1),def.promise},pPreferenceNode.prototype.node=function(n){},pPreferenceNode.prototype.nodes=function(p){},pPreferenceNode.prototype.parent=function(){},pPreferenceNode}angular.module("pluf").factory("PPreferenceNode",["PObject",PPreferenceNode])}(),function(){function PPreferenceProperty(PPreferenceNode){var pPreferenceProperty=function(){PPreferenceNode.apply(this,arguments)};return pPreferenceProperty.prototype=new PPreferenceNode,pPreferenceProperty.prototype.setValue=function(v){},pPreferenceProperty.prototype.value=function(){},pPreferenceProperty}angular.module("pluf").factory("PPreferenceProperty",["PPreferenceNode",PPreferenceProperty])}(),function(){function PProcess(PObject){var pProcess=function(){PObject.apply(this,arguments),this.progress||(this.progress={})};return pProcess.prototype.OK=0,pProcess.prototype.INFO=1,pProcess.prototype.WARNING=2,pProcess.prototype.ERROR=4,pProcess.prototype.CANCEL=8,pProcess.prototype.setWorked=function(w){return this.progress.worked=w,this},pProcess.prototype.worked=function(){return this.progress.worked},pProcess.prototype.addWorked=function(w){return this.progress.worked?this.progress.worked+=w:this.progress.worked=w,this},pProcess.prototype.setTotalWork=function(tw){return this.progress.totalWorked=tw,this},pProcess.prototype.totalWork=function(){return this.progress.totalWorked},pProcess.prototype.percentage=function(){return this.progress.totalWorked<=0?0:100*this.progress.worked/this.progress.worked},pProcess.prototype.setTaskName=function(t){return this.progress.taskName=t,this},pProcess.prototype.taskName=function(){return this.progress.taskName},pProcess.prototype.setSubTask=function(st){return this.progress.subTask=st,this},pProcess.prototype.subTask=function(){return this.progress.subTask},pProgressMonitor}angular.module("pluf").factory("PProcess",["PObject",PProcess])}(),function(){function PProfile($http,$httpParamSerializerJQLike,$q,PObject,PException){var pProfile=function(){PObject.apply(this,arguments)};return pProfile.prototype=new PObject,pProfile.prototype.update=function(key,value){if(this.user.isAnonymous()){var deferred=$q.defer();return deferred.reject(),deferred.promise}var scope=this,param={};return param[key]=value,$http({method:"POST",url:"/api/user/profile",data:$httpParamSerializerJQLike(param),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(data){return scope.setData(data),scope},function(data){throw new PException(data)})},pProfile}angular.module("pluf").factory("PProfile",["$http","$httpParamSerializerJQLike","$q","PObject","PException",PProfile])}(),function(){function PUser($http,$q,$httpParamSerializerJQLike,PObject,PProfile,PException){var pUser=function(){PObject.apply(this,arguments)};return pUser.prototype=new PObject,pUser.prototype.update=function(key,value){var scope=($q.defer(),this),param={};return"undefined"!=typeof key&&"undefined"!=typeof value?param[key]=value:param=this,$http({method:"POST",url:"/api/user/"+this.id,data:$httpParamSerializerJQLike(param),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(data){return scope.setData(data.data),scope},function(data){throw new PException(data)})},pUser.prototype.profile=function(){var deferred;if(this.isAnonymous())return deferred=$q.defer(),deferred.reject(),deferred.promise;if(this._prof&&!this._prof.isAnonymous())return deferred=$q.defer(),deferred.resolve(this._prof),deferred.promise;var scope=this;return $http({method:"GET",url:"/api/user/"+this.id+"/profile"}).then(function(res){return scope._prof=new PProfile(res.data),scope._prof.user=scope,scope._prof},function(res){throw new PException(res.data)})},pUser.prototype.isAdministrator=function(){return this.id&&this.id>0&&this.administrator},pUser}angular.module("pluf").factory("PUser",["$http","$q","$httpParamSerializerJQLike","PObject","PProfile","PException",PUser])}(),function(){function act($q,$timeout,PCommand,PHandler){this._commands=[],this.getCommand=function(id){var def=$q.defer(),scope=this;return $timeout(function(){return id in scope._commands?void def.resolve(scope._commands[id]):void def.reject({status:404,code:10,message:"command not found"})},1),def.promise},this.command=function(cmdData){if(!cmdData.id)throw{status:404,code:11,message:"Command id is empty"};var cmd;return cmd=cmdData.id in this._commands?this._commands[cmdData.id]:new PCommand(cmdData),this._commands[cmd.id]=cmd,this},this.handler=function(handData){var cmd;return handData.id in this._commands?cmd=this._commands[handData.id]:(cmd=new PCommand(handData),this._commands[cmd.id]=cmd),cmd.handler(new PHandler(handData)),this},this.execute=function(command){var def=$q.defer();if(command in this._commands){var scope=this,args=Array.prototype.slice.call(arguments).slice(1);$timeout(function(){var cmd=scope._commands[command];cmd.handlers.forEach(function(handler){handler.handle.apply(handler,args)}),def.resolve()},1)}else def.reject({message:"Command not found :"+command,statuse:400,code:4404});return def.promise}}angular.module("pluf").service("$act",["$q","$timeout","PCommand","PHandler",act])}(),function(){function cms($http,$httpParamSerializerJQLike,$q,$timeout,PContent,PNamedContent,PaginatorPage,PException){this._nc={},this._getnc=function(id){return this._nc[id]},this._retnc=function(id,d){var i=this._nc[id];return i?i.setData(d):(i=new PNamedContent(d),this._nc[id]=i),i},this._c={},this._getc=function(id){return this._c[id]},this._retc=function(id,c){var i=this._c[id];return i?i.setData(c):(i=new PContent(c),this._c[c.id]=i),i},this.newContent=function(c){var scope=this;return $http({method:"POST",url:"/api/saascms/content/new",data:$httpParamSerializerJQLike(c),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(res){return scope._retc(res.data.id,res.data)})},this.content=function(i){var t=this._getc(i);if(t){var deferred=$q.defer();return deferred.resolve(t),deferred.promise}return t=this,$http({method:"GET",url:"/api/saascms/content/"+i}).then(function(res){return t._retc(i,res.data)})},this.contents=function(p){var scope=this;return $http({method:"GET",url:"/api/saascms/contet/find",params:p.getParameter()}).then(function(res){var page=new PaginatorPage(res.data);page.items=[];for(var i=0;i<res.data.counts;i++){var t=scope._retc(page.items[i].id,page.items[i]);page.items.push(t)}return page},function(data){throw new PException(data)})},this.newNamedContent=function(n,c){var nc,scope=this;return $http({method:"POST",url:"/api/saascms/page/new",data:$httpParamSerializerJQLike({content:c.id,name:n}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(res){return nc=scope._retnc(res.data.name,res.data),scope.content(nc.content)}).then(function(c){return nc.content=c,nc})},this.namedContent=function(n){var t=this._getnc(n);if(t){var deferred=$q.defer();return deferred.resolve(t),deferred.promise}var nc,scope=this;return $http({method:"GET",url:"/api/saascms/page/"+n}).then(function(res){return nc=scope._retnc(res.data.name,res.data),scope.content(nc.content)}).then(function(c){return nc.content=c,nc})},this.namedContents=function(p){var scope=this;return $http({method:"GET",url:"/api/saascms/page/find",params:p.getParameter()}).then(function(res){var page=new PaginatorPage(res.data);page.items=[];for(var i=0;i<res.data.counts;i++)page.items.push(scope._retnc(res.data.items[i].name,res.data.items[i]));return page})}}angular.module("pluf").service("$cms",["$http","$httpParamSerializerJQLike","$q","$timeout","PContent","PNamedContent","PaginatorPage","PException",cms])}(),function(){function menu($q,$timeout,PMenu,PMenuItem){this.menus=[],this._addMenu=function(id,menu){id in this.menus||(this.menus[id]=new PMenu({id:id})),this.menus[id].item(menu)},this.menu=function(id){var def=$q.defer(),scope=this;return $timeout(function(){id in scope.menus||(scope.menus[id]=new PMenu({id:id})),def.resolve(scope.menus[id])},1),def.promise},this.addItem=function(id,menu){return this._addMenu(id,new PMenuItem(menu)),this}}angular.module("pluf").service("$menu",["$q","$timeout","PMenu","PMenuItem",menu])}(),function(){function notify($rootScope,$timeout,$q){this._listeners=[],this._fire=function(list,m){var deferred=$q.defer();return $timeout(function(){for(var i=0;i<list.length;i++)list[i].apply(list[i],new PMessage(m));deferred.resolve()},10),deferred.promise},this.onMessage=function(l){return this._listeners.push(l),this},this.info=function(message){return message.type="info",this._fire(this._info,message)},this.warning=function(message){return message.type="warning",this._fire(this._info,message)},this.debug=function(message){return message.type="debug",this._fire(this._info,message)},this.error=function(message){return message.type="error",this._fire(this._info,message)}}angular.module("pluf").service("$notify",["$rootScope","$timeout","$q",notify])}(),function(){function preference($rootScope){this.newNode=function(n){},this.node=function(path){},this.nodes=function(p){}}angular.module("pluf").service("$preference",["$rootScope",preference])}(),function(){function process(){this.processes=function(){},this.process=function(id){}}angular.module("pluf").service("$process",[process])}(),function(){function user($http,$httpParamSerializerJQLike,$q,$act,PUser){this._su=new PUser,this._u={},this._getUser=function(id){return this._u[id]&&!this._u[id].isAnonymous()?this._u[id]:null},this._ret=function(id,data){var instance=this._getUser(id);return instance?instance.setData(data):(instance=new PUser(data),this._u[id]=instance),instance},this.isAnonymous=function(){return this._su.isAnonymous()},this.isAdministrator=function(){return this._su.isAdministrator()},this.login=function(c){if(!this.isAnonymous()){var deferred=$q.defer();return deferred.resolve(this),deferred.promise}var scope=this;return $http({method:"POST",url:"/api/user/login",data:$httpParamSerializerJQLike(c),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(data){return scope._su=new PUser(data.data),scope._su})},this.session=function(){var scope=this;if(!this.isAnonymous()){var deferred=$q.defer();return deferred.resolve(this._su),deferred.promise}return $http.get("/api/user/account").then(function(data){return scope._su=new PUser(data.data),scope._su})},this.logout=function(){if(this.isAnonymous()){var deferred=$q.defer();return deferred.resolve(this._su),deferred.promise}var scope=this;return $http.get("/api/user/logout").success(function(data){return scope._su.setData({id:0,login:null,administrator:!1}),scope._su})},this.signup=function(detail){return $http({method:"POST",url:"/api/user/signup",data:$httpParamSerializerJQLike(detail),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(data){var user=new PUser(data.data);return user})},this.users=function(p){var scope=this;return $http({method:"GET",url:"/api/user/find",params:p.getParameter()}).then(function(data){for(var page=new PaginatorPage(res.data),items=[],i=0;i<page.counts;i++){var t=scope._ret(page.items[i].id,page.items[i]);items.push(t)}return page.items=items,page})},this.user=function(login){var scope=this;return $http({method:"GET",url:"/api/user/user/"+login}).then(function(data){return scope._ret(data.data.id,data.data)})}}angular.module("pluf").service("$usr",["$http","$httpParamSerializerJQLike","$q","$act","PUser",user])}();