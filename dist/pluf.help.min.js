/*! angular-pluf 2016-05-23 */
"use strict";angular.module("pluf.help",["pluf"]).factory("PWikiPageItem",function(PObject){var wikiPageItem=function(d){d&&this.setData(d)};return wikiPageItem.prototype=new PObject,wikiPageItem}).factory("PWikiPage",function(PObject){var wikiPage=function(d){d&&this.setData(d)};return wikiPage.prototype=new PObject,wikiPage.prototype.render=function(){return markdown.toHTML(this.content)},wikiPage}).factory("PWikiBook",function(PObject,PException,PWikiPageItem,PaginatorPage,$http,$q,$timeout){var pWikiBook=function(){PObject.apply(this,arguments)};return pWikiBook.prototype=new PObject,pWikiBook.prototype.getFisrtPage=function(){var def=$q.defer(),scope=this;return $timeout(function(){def.resolve(scope.items[0])},1),def.promise},pWikiBook.prototype.retItem=function(id,data){var item=null;for(var i in this.items)if(this.items[i].id==id){item=this.items[i];break}return item||(item=new PWikiPageItem(data),this.items.push(item)),item.setData(data),item},pWikiBook.prototype.updateItem=function(id,data){var item=null;for(var i in this.items)if(this.items[i].id==id){item=this.items[i];break}return item?(item.setData(data),item):null},pWikiBook.prototype.pages=function(){var scope=this;return $http({method:"GET",url:"/api/wiki/book/"+scope.id+"/pages"}).then(function(res){scope.items=[];for(var i=0;i<res.data.length;i++)scope.retItem(res.data[i].id,res.data[i]);return scope.items},function(data){throw new PException(data)})},pWikiBook.prototype.addPage=function(page){var scope=this;return $http({method:"POST",url:"/api/wiki/book/"+scope.id+"/page/"+page.id}).then(function(res){return scope},function(data){throw new PException(data)})},pWikiBook}).service("$help",function($http,$httpParamSerializerJQLike,$q,PException,PWikiPage,PWikiBook,PaginatorPage){this._ppage={},this._getPage=function(id){return this._ppage[id]},this._setPage=function(page){this._ppage[page.id]=page},this._retPage=function(id,data){var instance=this._getPage(id);return instance?instance.setData(data):(instance=new PWikiPage(data),this._setPage(instance)),instance},this._pbook={},this._getBook=function(id){return this._pbook[id]},this._setBook=function(page){this._pbook[page.id]=page},this._retBook=function(id,data){var instance=this._getBook(id);return instance?instance.setData(data):(instance=new PWikiBook(data),this._setBook(instance)),instance},this.books=function(p){var scope=this;return $http({method:"GET",url:"/api/wiki/book/find",params:p.getParameter()}).then(function(res){for(var page=new PaginatorPage(res.data),items=[],i=0;i<page.counts;i++){var t=scope._retBook(page.items[i].id,page.items[i]);items.push(t)}return page.items=items,page},function(data){throw new PException(data)})},this.createBook=function(b){var scope=this;return $http({method:"POST",url:"/api/wiki/book/create",data:$httpParamSerializerJQLike(b),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(res){var t=scope._retBook(res.data.id,res.data);return t},function(data){throw new PException(data)})},this.updateBook=function(b,k,v){var scope=this,param={};return param[k]=v,$http({method:"POST",url:"/api/wiki/book/"+b.id,data:$httpParamSerializerJQLike(param),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(res){var t=scope._retBook(res.data.id,res.data);return t},function(data){throw new PException(data)})},this.pages=function(p){var scope=this;return $http({method:"GET",url:"/api/wiki/page/find",params:p.getParameter()}).then(function(res){for(var page=new PaginatorPage(res.data),items=[],i=0;i<page.counts;i++){var t=scope._retPage(page.items[i].id,page.items[i]);items.push(t)}return page.items=items,page},function(data){throw new PException(data)})},this.page=function(id){var scope=this;return $http({method:"GET",url:"/api/wiki/page/"+id}).then(function(res){var page=scope._retPage(res.data.id,res.data);return page},function(data){throw new PException(data)})},this.createPage=function(p){var scope=this;return $http({method:"POST",url:"/api/wiki/page/create",data:$httpParamSerializerJQLike(p),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(res){var t=scope._retPage(res.data.id,res.data);return t},function(data){throw new PException(data)})},this.updatePage=function(p,k,v){var scope=this,param={};return param[k]=v,$http({method:"POST",url:"/api/wiki/page/"+p.id,data:$httpParamSerializerJQLike(param),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(res){var b=scope._getBook(res.data.book);return b&&b.updateItem(res.data.id,res.data),scope._retPage(res.data.id,res.data)},function(data){throw new PException(data)})}}).filter("unsafe",function($sce){return function(val){return $sce.trustAsHtml(val)}});